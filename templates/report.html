{% extends "base.html" %}

{% block content %}
    {% load staticfiles %}

    <h2 class="my-repositories-heading" style="font-family: 'Francois One', sans-serif;">{{ report.name }}</h2>

    <div class="large-12 columns">
        <a href="/repo/{{ repo_id }}/reports"><i class="fa fa-arrow-left"></i>&nbsp;All Reports</a>
    </div>

    {% for query in queries %}
    <div class="large-12 columns card">
        {% if query.query.model == "user" %}
            {% for result in query.query_result %}
                {% if forloop.counter <= 4 %}
                    <div class="large-6 columns" style="float:left;">
                        <div class="large-8 columns" style="margin-bottom: 10px;">
                            <a href="/authors/detail/{{ result.pk }}/{{ repo_id }}/{{ default_branch_id }}"><h5 class="blue-clicky-text"><b>{{ result.name }}</b></h5></a>
                        </div>
                        <div class="large-4 columns" style="font-size:19px;color:darkblue;">
                            {{ result.num_commits }}
                            &nbsp;<div style="font-size:12px;color:black;">commits</div>
                        </div>
                    </div>
                {% else %}
                    <div class="hide extra_committers-{{ query.query.pk }}">
                        <div class="large-6 columns" style="float:left;">
                            <div class="large-8 columns" style="margin-bottom: 10px;">
                                <a href="/authors/detail/{{ result.pk }}/{{ repo_id }}/{{ default_branch_id }}"><h5 class="blue-clicky-text"><b>{{ result.name }}</b></h5></a>
                            </div>
                            <div class="large-4 columns" style="font-size:19px;color:darkblue;">
                                {{ result.num_commits }}
                                &nbsp;<div style="font-size:12px;color:black;">commits</div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
            <div class="large-12 columns commithider-{{ query.query.pk }} blue-clicky-text" style="text-align: center; margin-top: 10px; color: black;">
                {% if query.query_result.count > 4 %}
                    View All ({{ query.query_result.count }})
                {% endif %}
            </div>
        {% endif %}
        <div class="large-12 columns" style="height:220px;text-align:center;margin-top: 40px;">
            <div id="chartcontainer-{{ query.query.pk }}" style="height:200px;width: 50%;margin:0 auto;"></div>
        </div>
    </div>
    {% endfor %}

{% endblock %}
{% block extra_js %}
    <script>
        {% for query in queries %}
        $(document).ready(function(){
            $(".commithider-{{ query.query.pk }}").click(
                    function(e){
                        e.preventDefault();
                        $(".extra_committers-{{ query.query.pk }}").slideToggle(200,function() {
                            $(".commithider-{{ query.query.pk }}").text($(this).is(':visible') ? "Show Less" : "View All ({{ query.query_result.count }})");
                        });
                    }
            )
        });

        {% if query.query.chart_type == "pie" %}
            $.plot('#chartcontainer-{{ query.query.pk }}', {{ query.response|safe }}, {
                series: {
                    pie: {
                        show: true,
                        radius: 1,
                        label: {
                            show: true,
                            radius: 1,
                            formatter: function (label, series) {
                                return '<div style="font-size:11px; text-align:center; padding:2px; color:white;">' + label + '<br/>' + Math.round(series.percent) + '%</div>';
                            },
                            threshold: 0.09,
                            background: {
                                opacity: 0.8,
                                color: '#444'
                            }
                        }
                    }
                },
                legend: {
                    show: false
                },
                grid: {
                    hoverable: true
                }
            });

            function showTooltip(x, y, contents, z) {
                $('<div id="flot-tooltip">' + contents + '</div>').css({
                    left: x,
                    top: y,
                    'border-color': z
                }).appendTo("body").fadeIn(200);
            }

            $("#chartcontainer-{{ query.query.pk }}").bind("plothover", function (event, pos, item) {
                if (item) {
                    if ((previousPoint != item.dataIndex) || (previousLabel != item.series.label)) {
                        previousPoint = item.dataIndex;
                        previousLabel = item.series.label;

                        $("#flot-tooltip").remove();

                        var e = window.event;
                        var x = e.clientX - 20 + 'px',
                                y = e.clientY - 20 + 'px',
                                z = item.series.color;
                        var percentage = Math.round(item.datapoint[0]);

                        showTooltip(x, y, "<b>" + item.series.label + "</b>, " + percentage + "%",
                                z);
                    }
                } else {
                    $("#flot-tooltip").remove();
                    previousPoint = null;
                }
            });
        {% elif query.query.chart_type == "bar" %}
            $.plot('#chartcontainer-{{ query.query.pk }}', [{{ query.response|safe }}], {
                series: {
                    bars: {
                        show: true,
                        barWidth: 0.6,
                        align: "center"
                    }
                },
                xaxis: {
                    mode: "categories",
                    tickLength: 0
                },
                yaxis: {
                    min: 0
                },
                grid: {
                    hoverable: true
                }
            });

            function showTooltip(x, y, contents, z) {
                $('<div id="flot-tooltip">' + contents + '</div>').css({
                    left: x,
                    top: y,
                    'border-color': z
                }).appendTo("body").fadeIn(200);
            }

            $("#chartcontainer-{{ query.query.pk }}").bind("plothover", function (event, pos, item) {
                if (item) {
                    if (previousPoint != item.dataIndex) {
                        previousPoint = item.dataIndex;

                        $("#flot-tooltip").remove();

                        var e = window.event;
                        var x = e.clientX - 20 + 'px',
                                y = e.clientY - 20 + 'px',
                                z = item.series.color;
                        var commitCount = item.datapoint[1];

                        showTooltip(x, y, "<b>" + commitCount + "</b>",
                                z);
                    }
                } else {
                    $("#flot-tooltip").remove();
                    previousPoint = null;
                }
            });
        {% elif query.query.chart_type == "line" %}
            $.plot('#chartcontainer-{{ query.query.pk }}', [{{ query.response|safe }}], {
                lines: { show: true },
                points: {
                    radius: 3,
                    show: true,
                    fill: true
                },
                xaxis: {
                    mode: "categories",
                    tickLength: 0
                },
                yaxis: {
                    min: 0
                },
                grid: {
                    hoverable: true
                }
            });

            function showTooltip(x, y, contents, z) {
                $('<div id="flot-tooltip">' + contents + '</div>').css({
                    left: x,
                    top: y,
                    'border-color': z
                }).appendTo("body").fadeIn(200);
            }

            $("#chartcontainer-{{ query.query.pk }}").bind("plothover", function (event, pos, item) {
                if (item) {
                    if (previousPoint != item.dataIndex) {
                        previousPoint = item.dataIndex;

                        $("#flot-tooltip").remove();

                        var e = window.event;
                        var x = e.clientX - 20 + 'px',
                                y = e.clientY - 20 + 'px',
                                z = item.series.color;
                        var count = item.datapoint[1];

                        showTooltip(x, y, "<b>" + count + "</b>",
                                z);
                    }
                } else {
                    $("#flot-tooltip").remove();
                    previousPoint = null;
                }
            });
        {% endif %}
        {% endfor %}
    </script>
{% endblock %}